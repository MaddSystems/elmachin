{% extends "/dashboard/base.html" %}
{% block title %}Gestión de Documentos{% endblock %}

{% block content %}
<div class="container py-4">
    <h1 class="text-center mb-4">Gestión de Documentos</h1>

    <table id="grid"></table>
    <div id="pager"></div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/free-jqgrid/js/jquery.jqgrid.min.js"></script>

<script>
$(document).ready(function () {
    // Inicializar el jqGrid
    $("#grid").jqGrid({
        url: '/get_documents',
        datatype: "json",
        mtype: "GET",
        colNames: ["ID", "Título", "Archivo", "Descripción", "Guardar En", "Clasificación", "Fecha de Creación"],
        colModel: [
            { label: 'ID', name: 'id', width: 50, key: true, editable: false },
            { label: 'Título', name: 'title_name', width: 150, editable: true },
            { 
                label: 'Archivo', 
                name: 'file_name', 
                width: 150, 
                editable: false,
                formatter: function(cellvalue, options, rowObject) {
                    return `<a href="${cellvalue}" target="_blank">${cellvalue}</a>`;
                }
            },
            { label: 'Descripción', name: 'description', width: 200, editable: true },
            { 
                label: 'Guardar En', 
                name: 'save_in', 
                width: 100, 
                editable: true, 
                edittype: 'select', 
                editoptions: { value: "1:Base de Datos;2:Public;3:Private" } 
            },
            { label: 'Clasificación', name: 'classification', width: 100, editable: true },
            { 
                label: 'Fecha de Creación', 
                name: 'created_at', 
                width: 150, 
                formatter: 'date', 
                formatoptions: { srcformat: 'Y-m-d H:i:s', newformat: 'd/m/Y H:i' }, 
                editable: false 
            }
        ],
        pager: "#pager",
        rowNum: 10,
        rowList: [10, 20, 30],
        sortname: "id",
        sortorder: "desc",
        viewrecords: true,
        gridview: true,
        height: 400,
        width: 1200,        
        caption: "Lista de Documentos",
        loadError: function(xhr, status, error) {
            console.error("Error loading data:", error, xhr.responseText);
        }
    });

    // Habilitar la barra de búsqueda
    $("#grid").jqGrid('filterToolbar', {
        stringResult: true,
        searchOnEnter: false,
        defaultSearch: "cn"
    });

    // Agregar botones de editar, eliminar y agregar
    $("#grid").jqGrid('navGrid', '#pager',
        { edit: true, add: false, del: true, search: true, refresh: true },
        {
            url: "/edit_document",
            mtype: "PUT",
            closeAfterEdit: true,
            beforeSubmit: function(postData) {
                if (!postData.title_name || !postData.save_in) {
                    return [false, "Todos los campos obligatorios deben estar completos"];
                }
                return [true, ""];
            },
            serializeEditData: function(postData) {
                return JSON.stringify(postData);
            },
            ajaxEditOptions: { contentType: "application/json" },
            afterSubmit: function(response) {
                return response.responseJSON.error ? [false, response.responseJSON.error] : [true, "", ""];
            }
        },
        {}, // No usamos "add" aquí porque ya tenemos un botón personalizado
        {
            url: "/delete_document",
            mtype: "DELETE",
            closeAfterDel: true,
            serializeDelData: function(postData) {
                return JSON.stringify({ id: postData.id });
            },
            ajaxDelOptions: { contentType: "application/json" },
            afterSubmit: function(response) {
                return response.responseJSON.error ? [false, response.responseJSON.error] : [true, "", ""];
            }
        }
    );
    // Botón personalizado para agregar documentos
    $("#grid").jqGrid('navButtonAdd', '#pager', {
        caption: "",
        buttonicon: "ui-icon-plus",
        onClickButton: function() {
            const formHtml = `
                <form id="add-document-form" enctype="multipart/form-data">
                    <label for="title_name">Título:</label>
                    <input type="text" id="title_name" name="title_name" required><br>
                    <label for="file">Archivo:</label>
                    <input type="file" id="file" name="file" required><br>
                    <label for="description">Descripción:</label>
                    <textarea id="description" name="description"></textarea><br>
                    <label for="save_in">Guardar En:</label>
                    <select id="save_in" name="save_in" required>
                        <option value="1">Base de Datos</option>
                        <option value="2">Public</option>
                        <option value="3">Private</option>
                    </select><br>
                    <label for="classification">Clasificación:</label>
                    <input type="number" id="classification" name="classification"><br>
                </form>
            `;

            const dialog = $("<div>").html(formHtml).dialog({
                title: "Agregar Documento",
                width: 400,
                modal: true,
                buttons: {
                    "Guardar": function() {
                        const formData = new FormData($("#add-document-form")[0]);
                        $.ajax({
                            url: "/add_document",
                            method: "POST",
                            data: formData,
                            processData: false,
                            contentType: false,
                            success: function(response) {
                                alert("Documento agregado exitosamente");
                                $("#grid").trigger("reloadGrid");
                                dialog.dialog("close");
                            },
                            error: function(xhr, status, error) {
                                alert("Error al agregar el documento: " + xhr.responseText);
                            }
                        });
                    },
                    "Cancelar": function() {
                        dialog.dialog("close");
                    }
                }
            });
        }
    });
});
</script>
{% endblock %}